@model FitnessCenter.Models.ViewModels.AIRecommendationViewModel
@using System.Text
@using System.Text.RegularExpressions

@functions {
    private string ProcessInline(string s)
    {
        if (string.IsNullOrEmpty(s)) return string.Empty;
        s = System.Net.WebUtility.HtmlEncode(s);
        s = Regex.Replace(s, "\\*\\*(.+?)\\*\\*", "<strong>$1</strong>");
        s = Regex.Replace(s, "\\*(.+?)\\*", "<em>$1</em>");
        return s;
    }

    public string RenderMarkdown(string md)
    {
        if (string.IsNullOrWhiteSpace(md)) return string.Empty;
        var sb = new StringBuilder();
        var lines = md.Replace("\r", "").Split('\n');
        bool inUl = false, inOl = false;

        foreach (var raw in lines)
        {
            var line = raw.TrimEnd();

            if (Regex.IsMatch(line, "^###\\s"))
            {
                if (inUl) { sb.AppendLine("</ul>"); inUl = false; }
                if (inOl) { sb.AppendLine("</ol>"); inOl = false; }
                sb.AppendLine($"<h4>{ProcessInline(line.Substring(4))}</h4>");
            }
            else if (Regex.IsMatch(line, "^##\\s"))
            {
                if (inUl) { sb.AppendLine("</ul>"); inUl = false; }
                if (inOl) { sb.AppendLine("</ol>"); inOl = false; }
                sb.AppendLine($"<h3>{ProcessInline(line.Substring(3))}</h3>");
            }
            else if (Regex.IsMatch(line, "^\\d+\\.\\s"))
            {
                if (inUl) { sb.AppendLine("</ul>"); inUl = false; }
                if (!inOl) { sb.AppendLine("<ol class=\"rec-list\">"); inOl = true; }
                var item = Regex.Replace(line, "^\\d+\\.\\s", "");
                sb.AppendLine($"<li>{ProcessInline(item.Trim())}</li>");
            }
            else if (line.TrimStart().StartsWith("- "))
            {
                if (inOl) { sb.AppendLine("</ol>"); inOl = false; }
                if (!inUl) { sb.AppendLine("<ul class=\"rec-list\">"); inUl = true; }
                sb.AppendLine($"<li>{ProcessInline(line.Trim().Substring(2))}</li>");
            }
            else if (string.IsNullOrWhiteSpace(line))
            {
                if (inUl) { sb.AppendLine("</ul>"); inUl = false; }
                if (inOl) { sb.AppendLine("</ol>"); inOl = false; }
                sb.AppendLine("<p></p>");
            }
            else
            {
                sb.AppendLine($"<p>{ProcessInline(line)}</p>");
            }
        }

        if (inUl) sb.AppendLine("</ul>");
        if (inOl) sb.AppendLine("</ol>");

        return sb.ToString();
    }
}
@{
    ViewData["Title"] = "Yapay Zeka Önerileri";
    ViewData["NoTopPadding"] = true;
}

<style>
    .page-header {
        background: linear-gradient(135deg, rgba(0, 210, 106, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%);
        padding: 60px 0;
        padding-top: 140px;
        margin-bottom: 50px;
        border-bottom: 1px solid rgba(0, 210, 106, 0.2);
    }

    .page-header h1 {
        font-size: 3rem;
        font-weight: 800;
        background: linear-gradient(135deg, #00d26a 0%, #00ff88 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .ai-card, .bmi-card, .result-card {
        background: linear-gradient(145deg, #12121c 0%, #0d0d14 100%);
        border: 1px solid rgba(0, 210, 106, 0.1);
        border-radius: 20px;
        overflow: hidden;
    }

    /* Improved text contrast to match Profile page styles */
    .ai-card, .bmi-card, .result-card { color: #d6d6d6; }
    .ai-card .card-body, .bmi-card .card-body, .result-card .card-body { color: #dfe6e9; }
    .ai-card .card-header h5, .bmi-card .card-header h6, .result-card .card-header h5 { color: #fff; }
    .recommendation-content p, .recommendation-content .rec-list, .feature-item { color: #dfe6e9; }
    .recommendation-content h3, .recommendation-content h4 { color: #fff; }
    .recommendation-content h4 { color: #00d26a; }
    .alert-custom { color: #00d26a; }

    .ai-card .card-header, .bmi-card .card-header, .result-card .card-header {
        background: linear-gradient(135deg, rgba(0, 210, 106, 0.15) 0%, rgba(0, 210, 106, 0.05) 100%);
        color: #fff;
        padding: 25px 30px;
        border-bottom: 1px solid rgba(0, 210, 106, 0.1);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.25rem; /* match Profile edit-card header */
    }

    /* Ensure header elements inside cards follow Profile edit-card header sizing */
    .ai-card .card-header h5, .bmi-card .card-header h6, .result-card .card-header h5 {
        margin: 0;
        color: inherit;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: inherit; /* inherit 1.25rem from parent */
        font-weight: inherit;
    }

    .ai-card .card-header i, .bmi-card .card-header i, .result-card .card-header i,
    .edit-card-header i {
        font-size: 1.25rem; /* match icon size */
        color: #00d26a; /* theme green for icons */
        line-height: 1;
    }

    .ai-card .card-body, .bmi-card .card-body, .result-card .card-body {
        padding: 30px;
    }

    .form-label {
        color: #b8b8b8;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: #fff;
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        background: rgba(0, 210, 106, 0.05);
        border-color: #00d26a;
        box-shadow: 0 0 0 3px rgba(0, 210, 106, 0.1);
        color: #fff;
    }

    .form-control.is-invalid, .form-select.is-invalid {
        background: rgba(255, 71, 87, 0.05);
        border-color: #ff4757;
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
    }

    .form-control.is-invalid:focus, .form-select.is-invalid:focus {
        background: rgba(255, 71, 87, 0.05);
        border-color: #ff4757;
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
    }

    /* Placeholder / passive text color aligned with Profile page */
    .form-control::placeholder,
    .form-select::placeholder {
        color: #666;
        opacity: 1; /* ensure consistent visibility across browsers */
    }
    .form-control:-ms-input-placeholder { color: #666; }
    .form-control::-ms-input-placeholder { color: #666; }

    /* Make readonly/disabled inputs slightly lighter as well */
    .form-control[readonly], .form-control[disabled], .form-select[disabled] {
        color: #d6d6d6;
        background: rgba(255,255,255,0.02);
        border-color: rgba(255,255,255,0.06);
    }

    .form-select option {
        background: #12121c;
        color: #fff;
    }

    .input-group-text {
        background: rgba(0, 210, 106, 0.2);
        border: 1px solid rgba(0, 210, 106, 0.2);
        color: #00d26a;
        border-radius: 0 12px 12px 0;
    }

    .input-group .form-control {
        border-radius: 12px 0 0 12px;
    }

    .btn-ai {
        background: linear-gradient(135deg, #00d26a 0%, #00ff88 100%);
        border: none;
        color: #000;
        font-weight: 700;
        padding: 15px 30px;
        border-radius: 30px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .btn-ai:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(0, 210, 106, 0.4);
        color: #000;
    }

    .bmi-card {
        margin-top: 25px;
    }

    .recommendation-content {
        line-height: 1.9;
        color: #e0e0e0;
    }

    .recommendation-content h3, .recommendation-content h4 {
        color: #fff;
        margin: 0 0 10px 0;
        font-weight: 700;
    }

    .recommendation-content h3 {
        font-size: 1.25rem;
    }

    .recommendation-content h4 {
        font-size: 1.05rem;
        color: #00d26a;
    }

    .recommendation-content p {
        margin: 8px 0;
        color: #dfe6e9;
    }

    .recommendation-content .rec-list {
        margin: 8px 0 16px 1.25rem;
        color: #e0e0e0;
    }

    .recommendation-content .rec-list li {
        margin-bottom: 6px;
    }

    .recommendation-content strong {
        color: #fff;
    }

    .recommendation-note {
        color: #bdbdbd;
        font-style: italic;
        margin-top: 12px;
    }

    .recommendation-content strong {
        color: #00d26a;
    }

    .empty-result {
        text-align: center;
        padding: 60px 30px;
    }

    .empty-result i {
        color: rgba(0, 210, 106, 0.3);
        font-size: 5rem;
        margin-bottom: 25px;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        color: #b8b8b8;
    }

    .feature-item i {
        color: #00d26a;
        font-size: 1.3rem;
        margin-bottom: 0;
    }

    .alert-custom {
        background: rgba(0, 210, 106, 0.1);
        border: 1px solid rgba(0, 210, 106, 0.3);
        color: #00d26a;
        border-radius: 15px;
        padding: 20px;
    }

    .alert-custom a {
        color: #00ff88;
    }

    .progress {
        background: rgba(0, 210, 106, 0.1);
        border-radius: 10px;
        height: 12px;
    }
</style>

<!-- Page Header -->
<div class="page-header text-center" data-aos="fade-down">
    <div class="container">
        <h1><i class="bi bi-robot me-2"></i> Yapay Zeka Fitness Asistanı</h1>
        <p class="lead text-white-50 mt-3">Kişisel fitness ve beslenme önerilerinizi alın</p>
    </div>
</div>

<div class="container pb-5">
    <div class="row">
        <!-- Sol Taraf - Form -->
        <div class="col-lg-5 mb-4" data-aos="fade-right">
            <div class="ai-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Bilgilerinizi Girin</h5>
                </div>
                <div class="card-body">
                    <form asp-action="GetRecommendation" method="post" id="aiForm">
                        <div class="mb-4">
                            <label asp-for="Height" class="form-label">Boy (cm) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input asp-for="Height" type="number" class="form-control" placeholder="175" min="100" max="250" required
                                       data-val="true" data-val-required="Boy (cm) alanı zorunludur.">
                                <span class="input-group-text">cm</span>
                            </div>
                            <span asp-validation-for="Height" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Weight" class="form-label">Kilo (kg) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input asp-for="Weight" type="number" step="0.1" class="form-control" placeholder="70" min="30" max="300" required
                                       data-val="true" data-val-required="Kilo (kg) alanı zorunludur.">
                                <span class="input-group-text">kg</span>
                            </div>
                            <span asp-validation-for="Weight" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Age" class="form-label">Yaş <span class="text-danger">*</span></label>
                            <input asp-for="Age" type="number" class="form-control" placeholder="25" min="10" max="100" required
                                   data-val="true" data-val-required="Yaş alanı zorunludur.">
                            <span asp-validation-for="Age" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Gender" class="form-label">Cinsiyet <span class="text-danger">*</span></label>
                            <select asp-for="Gender" class="form-select" required
                                    data-val="true" data-val-required="Cinsiyet alanı zorunludur.">
                                <option value="">Seçin...</option>
                                <option value="Erkek">Erkek</option>
                                <option value="Kadın">Kadın</option>
                            </select>
                            <span asp-validation-for="Gender" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="BodyType" class="form-label">Vücut Tipi <span class="text-danger">*</span></label>
                            <select asp-for="BodyType" class="form-select" required
                                    data-val="true" data-val-required="Vücut Tipi alanı zorunludur.">
                                <option value="">Seçin...</option>
                                <option value="Ektomorf">Ektomorf (İnce yapılı)</option>
                                <option value="Mezomorf">Mezomorf (Atletik)</option>
                                <option value="Endomorf">Endomorf (Geniş yapılı)</option>
                                <option value="Normal">Normal</option>
                            </select>
                            <span asp-validation-for="BodyType" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="FitnessGoal" class="form-label">Fitness Hedefiniz <span class="text-danger">*</span></label>
                            <select asp-for="FitnessGoal" class="form-select" required
                                    data-val="true" data-val-required="Fitness Hedefiniz alanı zorunludur.">
                                <option value="">Seçin...</option>
                                <option value="WeightLoss">Kilo Vermek</option>
                                <option value="MuscleGain">Kas Kazanmak</option>
                                <option value="Endurance">Dayanıklılık Arttırmak</option>
                                <option value="Flexibility">Esneklik Geliştirmek</option>
                                <option value="GeneralFitness">Genel Fitness</option>
                            </select>
                            <span asp-validation-for="FitnessGoal" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ActivityLevel" class="form-label">Aktivite Seviyesi <span class="text-danger">*</span></label>
                            <select asp-for="ActivityLevel" class="form-select" required
                                    data-val="true" data-val-required="Aktivite Seviyesi alanı zorunludur.">
                                <option value="">Seçin...</option>
                                <option value="Sedentary">Hareketsiz (Masa başı iş)</option>
                                <option value="LightlyActive">Az Aktif (Hafif egzersiz)</option>
                                <option value="ModeratelyActive">Orta Aktif (3-5 gün spor)</option>
                                <option value="VeryActive">Çok Aktif (Günlük spor)</option>
                                <option value="ExtremelyActive">Aşırı Aktif (Profesyonel sporcu)</option>
                            </select>
                            <span asp-validation-for="ActivityLevel" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="HealthConditions" class="form-label">Sağlık Durumu (Opsiyonel)</label>
                            <textarea asp-for="HealthConditions" class="form-control" rows="2" 
                                      placeholder="Varsa kronik hastalık, alerji vb."></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-ai" id="submitBtn">
                                <i class="bi bi-magic"></i> Öneri Al
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- BMI Hesaplama -->
            <div class="bmi-card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-calculator text-primary-custom me-2"></i>Vücut Kitle İndeksi (BMI)</h6>
                </div>
                <div class="card-body">
                    <div id="bmiResult" class="text-center">
                        <p class="text-white-50">Boy ve kilo bilgilerini girin</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sağ Taraf - Sonuçlar -->
        <div class="col-lg-7" data-aos="fade-left">
            @if (!string.IsNullOrEmpty(Model?.Recommendation))
            {
                <!-- Öneriler -->
                <div class="result-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning-charge-fill me-2"></i>Kişiselleştirilmiş Öneriler</h5>
                    </div>
                    <div class="card-body">
                        <div class="recommendation-content">
                            @Html.Raw(RenderMarkdown(Model.Recommendation))
                        </div>
                    </div>
                </div>

                <div class="alert-custom">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Not:</strong> Bu öneriler genel bilgi amaçlıdır. Detaylı program için antrenörlerimize danışmanızı öneririz.
                    <a asp-controller="Trainer" asp-action="Index">Antrenörlerimizi inceleyin →</a>
                </div>
            }
            else
            {
                <div class="result-card">
                    <div class="card-body empty-result">
                        <i class="bi bi-robot"></i>
                        <h4 class="text-white mb-3">Kişiselleştirilmiş Öneriler</h4>
                        <p class="text-white-50 mb-4">
                            Soldaki formu doldurarak yapay zeka destekli kişiselleştirilmiş 
                            egzersiz ve beslenme önerilerinizi alabilirsiniz.
                        </p>
                        <div class="row text-start mt-4">
                            <div class="col-md-6">
                                <div class="feature-item">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>Vücut tipinize özel egzersizler</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="feature-item">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>Hedeflerinize yönelik program</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="feature-item">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>Kişiselleştirilmiş beslenme planı</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="feature-item">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>Günlük kalori hesaplama</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const heightInput = document.getElementById('Height');
        const weightInput = document.getElementById('Weight');
        const bmiResult = document.getElementById('bmiResult');
        const submitBtn = document.getElementById('submitBtn');
        const aiForm = document.getElementById('aiForm');

        function calculateBMI() {
            const height = parseFloat(heightInput.value) / 100;
            const weight = parseFloat(weightInput.value);

            if (height > 0 && weight > 0) {
                const bmi = weight / (height * height);
                let category, colorClass;

                if (bmi < 18.5) {
                    category = 'Zayıf';
                    colorClass = 'text-info';
                } else if (bmi < 25) {
                    category = 'Normal';
                    colorClass = 'text-primary-custom';
                } else if (bmi < 30) {
                    category = 'Fazla Kilolu';
                    colorClass = 'text-warning';
                } else {
                    category = 'Obez';
                    colorClass = 'text-danger';
                }

                bmiResult.innerHTML = `
                    <h2 class="${colorClass}" style="font-size: 2.5rem; font-weight: 800;">${bmi.toFixed(1)}</h2>
                    <p class="${colorClass} mb-3"><strong>${category}</strong></p>
                    <div class="progress mt-3">
                        <div class="progress-bar" style="width: ${Math.min(bmi * 2, 100)}%; background: linear-gradient(135deg, #00d26a 0%, #00ff88 100%);"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2 text-white-50" style="font-size: 0.8rem;">
                        <small>18.5</small>
                        <small>25</small>
                        <small>30+</small>
                    </div>
                `;
            } else {
                bmiResult.innerHTML = '<p class="text-white-50">Boy ve kilo bilgilerini girin</p>';
            }
        }

        // Sayfa yüklendiğinde BMI hesaplaması yap
        window.addEventListener('DOMContentLoaded', function() {
            calculateBMI();
        });

        // Input alanları değiştiğinde BMI hesaplaması yap
        heightInput.addEventListener('input', calculateBMI);
        weightInput.addEventListener('input', calculateBMI);

        // Form gönderildiğinde buton durumunu değiştir
        aiForm.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analiz Ediliyor...';
        });
    </script>
}
